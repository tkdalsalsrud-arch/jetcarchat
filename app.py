import streamlit as st
import google.generativeai as genai
import pandas as pd
from pathlib import Path

# --- 0. í˜ì´ì§€ ì„¤ì • ë° ë””ìì¸ ---
st.set_page_config(page_title="JETCAR ì§ì› ì§€ì› ì‹œìŠ¤í…œ", page_icon="ğŸï¸")

st.markdown("""
<style>
    div[data-testid="chat-message-container"] { border-radius: 10px; padding: 10px 14px; margin-bottom: 10px; }
    div[data-testid="chat-message-container"]:has(div[data-testid="stChatMessageContent-user"]) { background-color: #F0F2F6; color: #333; }
    div[data-testid="chat-message-container"]:has(div[data-testid="stChatMessageContent-assistant"]) { background-color: #4A90E2; color: white; }
</style>
""", unsafe_allow_html=True)

# --- 1. í‚¤ì›Œë“œ ë°ì´í„° ì •ì˜ ---
KEYWORDS_CONDITION = ["ë¬´ì‹¬ì‚¬ì¥ê¸°ë ŒíŠ¸ì¹´","ë¬´ì‹¬ì‚¬ë ŒíŠ¸ì¹´","ì‹ ìš©ë¶ˆëŸ‰ìì¤‘ê³ ì°¨","ì‹ ìš©íšŒë³µì¥ê¸°ë ŒíŠ¸","ì‹ ìš©íšŒë³µì¤‘ì¥ê¸°ë ŒíŠ¸","ì‹ ìš©íšŒë³µì¤‘ì¤‘ì¤‘ê³ ì°¨","ì—°ì²´ìì¤‘ê³ ì°¨","ì¥ê¸°ë ŒíŠ¸ì¹´ì‹ ìš©","ì €ì‹ ìš©ë ŒíŠ¸ì¹´","ì €ì‹ ìš©ìì¥ê¸°ë ŒíŠ¸","ì €ì‹ ìš©ìì¥ê¸°ë ŒíŠ¸ì¹´","ì €ì‹ ìš©ì¥ê¸°ë ŒíŠ¸ì¹´","ì¤‘ê³ ì¥ê¸°ë Œí„°ì¹´","ì¤‘ê³ ì¥ê¸°ë ŒíŠ¸","ì¤‘ê³ ì¥ê¸°ë ŒíŠ¸ì¹´","ì¤‘ê³ ì°¨ì¥ê¸°ë ŒíŠ¸","ì¤‘ê³ ì°¨ë ŒíŠ¸","ì¤‘ê³ ì°¨ë ŒíŠ¸ì¹´","ìë™ì°¨1ë…„ë ŒíŠ¸","1ë…„ë ŒíŠ¸ì¹´","1ë…„ì¥ê¸°ë ŒíŠ¸","ê°œì¸íšŒìƒë Œíƒˆ","ê°œì¸íšŒìƒìì¥ê¸°ë ŒíŠ¸","ê°œì¸íšŒìƒì¥ê¸°ë ŒíŠ¸"]
KEYWORDS_LOCATION_BIZ = ["ê°œì¸ì‚¬ì—…ë ŒíŠ¸ì¹´","ê°œì¸ì‚¬ì—…ìë ŒíŠ¸","ê°œì¸ì‚¬ì—…ìì¥ê¸°ë ŒíŠ¸","ë²•ì¸ë Œí„°ì¹´","ë²•ì¸ë ŒíŠ¸","ë²•ì¸ë ŒíŠ¸ê²¬ì ","ë²•ì¸ë ŒíŠ¸ì¹´","ë²•ì¸ì¥ê¸°ë Œí„°ì¹´","ë²•ì¸ì¥ê¸°ë ŒíŠ¸","ë²•ì¸ì¥ê¸°ë ŒíŠ¸ê²¬ì ","ë²•ì¸ì¥ê¸°ë ŒíŠ¸ì¹´","ë²•ì¸ì¥ê¸°ë ŒíŠ¸ì¹´ê²¬ì ","ë²•ì¸ì°¨ëŸ‰ë ŒíŠ¸","ì‚¬ì—…ìë ŒíŠ¸","ì‚¬ì—…ìë ŒíŠ¸ì¹´","ì‚¬ì—…ìì¥ê¸°ë ŒíŠ¸","ì‹ ê·œë²•ì¸ì¥ê¸°ë ŒíŠ¸"]
CAR_MODELS = ["ëª¨ë‹", "ë ˆì´", "ë‹ˆë¡œ", "ìŠ¤í† ë‹‰", "ì…€í† ìŠ¤", "ìŠ¤í¬í‹°ì§€", "ì˜ë Œí† ", "ëª¨í•˜ë¹„", "ì¹´ë‹ˆë°œ", "EV3", "EV4", "EV6", "EV9", "G70", "G80", "G90", "GV60", "GV70", "GV80", "GV90", "EQ900", "SM3", "SM5", "SM6", "SM7", "XM3", "QM5", "QM6", "ê·¸ë‘ì½œë ˆì˜¤ìŠ¤", "ì•„ë¥´ì¹´ë‚˜", "QM3", "í‹°ë³¼ë¦¬", "í† ë ˆìŠ¤", "ì•¡í‹°ì–¸", "ë ‰ìŠ¤í„´", "ì½”ë€ë„", "ìŠ¤íŒŒí¬", "íŠ¸ë™ìŠ¤", "íŠ¸ë ˆì¼ë¸”ë ˆì´ì €", "Aí´ë˜ìŠ¤", "Cí´ë˜ìŠ¤", "Eí´ë˜ìŠ¤", "Sí´ë˜ìŠ¤", "GLCí´ë˜ìŠ¤", "GLEí´ë˜ìŠ¤", "CLAí´ë˜ìŠ¤", "CLEí´ë˜ìŠ¤", "CLSí´ë˜ìŠ¤", "EQ", "X1", "X3", "X4", "X5", "X6", "X7", "1ì‹œë¦¬ì¦ˆ", "3ì‹œë¦¬ì¦ˆ", "5ì‹œë¦¬ì¦ˆ", "7ì‹œë¦¬ì¦ˆ", "GT", "i3", "i4", "i5", "i7", "ix", "ì•„í…Œì˜¨", "í‹°êµ¬ì•ˆ", "ê³¨í”„", "ì œíƒ€"]

# --- 2. API ì„¤ì • ë° ë°ì´í„° ë¡œë“œ ---
try:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
except Exception as e:
    st.error("ğŸš¨ API í‚¤ ì˜¤ë¥˜: .streamlit/secrets.toml íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
    st.stop()

@st.cache_data
def load_car_data():
    try:
        context_file = Path("cars_data.xlsx")
        if not context_file.exists(): return None, "ğŸš¨ 'cars_data.xlsx' íŒŒì¼ì´ ê²½ë¡œì— ì—†ìŠµë‹ˆë‹¤."
        df = pd.read_excel(context_file, engine="openpyxl")
        return df, None
    except Exception as e: return None, f"ğŸš¨ ì—‘ì…€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}"

df_cars, error_msg = load_car_data()
if error_msg: st.error(error_msg); st.stop()

# --- 3. ì„¸ì…˜ ê´€ë¦¬ ---
if "messages" not in st.session_state:
    st.session_state.messages = [{"role": "assistant", "content": "ì œíŠ¸ì¹´ ì§ì› ì „ìš© ì‹œìŠ¤í…œì…ë‹ˆë‹¤. ì°¾ìœ¼ì‹œëŠ” ì°¨ëŸ‰ëª…ì´ë‚˜ ì°¨ëŸ‰ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."}]

# --- 4. ì‘ë‹µ ìƒì„± í•¨ìˆ˜ ---
def generate_ai_response(user_input):
    st.session_state.messages.append({"role": "user", "content": user_input})
    with st.chat_message("user"): st.markdown(user_input)

    with st.chat_message("assistant"):
        with st.spinner("ë°ì´í„° ë¶„ì„ ë° ì„œì‹ êµ¬ì„± ì¤‘..."):
            try:
                car_text_context = df_cars.to_string(index=False)
                
                system_prompt = f"""
                ë‹¹ì‹ ì€ ì œíŠ¸ì¹´(JETCAR) ìƒë‹´ ì§ì›ì„ ë•ëŠ” AI ë¹„ì„œì…ë‹ˆë‹¤.
                ì œê³µëœ [ì°¨ëŸ‰ í˜„í™© ë°ì´í„°]ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”.

                [ë°ì´í„°]
                {car_text_context}

                [í•„ìˆ˜ ì§€ì‹œ ì‚¬í•­ - ì ˆëŒ€ ëˆ„ë½ ê¸ˆì§€]
                1. ì°¨ëŸ‰ ì œëª© í˜•ì‹:
                   í˜•ì‹: **[ì „êµ­] ì°¨ëŸ‰ëª… (ë¶„ë¥˜1 / ë¶„ë¥˜2 / ë¶„ë¥˜3) ìµœê³ ê°€ê°œì›”ìˆ˜ ì—°ì‹ ì—°ë£Œ êµ¬ë™ë°©ì‹ ì¸ìŠ¹**
                   - [êµ¬ë™ë°©ì‹ ì¡°ê±´ë¶€ ì¶œë ¥]: 
                     ë°ì´í„°ì— 'AWD' ë˜ëŠ” '4WD'ë¼ëŠ” ë‹¨ì–´ê°€ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ í•´ë‹¹ ë‹¨ì–´ë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ê³ , ê·¸ ë’¤ì— "2WD"ë¥¼ ì ˆëŒ€ ë¶™ì´ì§€ ë§ˆì„¸ìš”.
                     ë§Œì•½ ë°ì´í„°ì— 'AWD'ë‚˜ '4WD'ê°€ ì „í˜€ ì—†ë‹¤ë©´, ìˆ˜ë™ìœ¼ë¡œ "2WD"ë¥¼ ì œëª© ëì— ë¶™ì—¬ì•¼ í•©ë‹ˆë‹¤.
                   - ì¸ìŠ¹: ë°ì´í„°ì— ëª…ì‹œëœ ì¸ìŠ¹ì„ ì ë˜, ì—†ìœ¼ë©´ "5ì¸ìŠ¹"ì„ ê¸°ë³¸ìœ¼ë¡œ ë¶™ì´ì„¸ìš”.
                   - ì°¨ëŸ‰ëª… ìì²´ì— ê¸ˆì•¡ì„ í‘œì‹œí•˜ì§€ ë§ˆì„¸ìš”.
                   - ì—°ì‹ ìˆ«ì ë’¤ì—ëŠ” ë°˜ë“œì‹œ "ì—°ì‹" ë‹¨ì–´ë¥¼ ë¶™ì´ì„¸ìš”. (ì˜ˆ: 2023ì—°ì‹)

                2. 3ë‹¨ í‚¤ì›Œë“œ ì¡°í•© ê·œì¹™:
                   - ë¶„ë¥˜1 (ì¡°ê±´): {KEYWORDS_CONDITION} ì¤‘ ì„ íƒ. (ì£¼í–‰ê±°ë¦¬ 30KM ì´í•˜ ì‹ ì°¨ê¸‰ ì°¨ëŸ‰ì€ 'ì¤‘ê³ ì°¨' ë‹¨ì–´ í¬í•¨ í‚¤ì›Œë“œ ì„ íƒ ê¸ˆì§€)
                   - ë¶„ë¥˜2 (ì§€ì—­/ì‚¬ì—…ì): {KEYWORDS_LOCATION_BIZ} ì¤‘ ì„ íƒ.
                   - ë¶„ë¥˜3 (ëª¨ë¸): ì°¨ëŸ‰ëª…ì—ì„œ {CAR_MODELS} ì¤‘ ì¼ì¹˜í•˜ëŠ” ëª¨ë¸ ì¶”ì¶œ í›„ 'ëª¨ë¸ëª…ì¥ê¸°ë ŒíŠ¸ì¹´'ë¡œ í‘œê¸°.

                3. ë ŒíŠ¸ë¹„ìš© ì•ˆë‚´ (ë°ì´í„° ê¸°ë°˜ ê°€ë³€ ì¶œë ¥):
                   - ì—‘ì…€ ë°ì´í„°ì—ì„œ í•´ë‹¹ ì°¨ëŸ‰ì˜ ëª¨ë“  ê°œì›”ìˆ˜ì™€ ê¸ˆì•¡ ì»¬ëŸ¼ì„ ì°¾ì•„ í•œ ì¤„ì”© í‘œì‹œí•˜ì„¸ìš”.
                   - í˜•ì‹:
                   ğŸ’¸ ë ŒíŠ¸ë¹„ìš©
                   ë³´ì¦ê¸ˆ 80ë§Œì›
                   ì •ë¹„ í¬í•¨ ì—¬ë¶€ : ì •ë¹„ ë¯¸í¬í•¨
                   íƒì†¡ë£Œ : ë³„ë„ 

                   ğŸ“† (ë°ì´í„° ê°œì›”ìˆ˜) (í•´ë‹¹ ê¸ˆì•¡)ë§Œì›

                4. ìƒì„¸ ì„œì‹ ì˜ˆì‹œ:
                   ğŸ“Œ ì°¨ëŸ‰ì •ë³´
                   ì°¨ëŸ‰ëª…: 
                   ì£¼í–‰ê±°ë¦¬ : 
                   ì—°ì‹: 
                   ì—°ë£Œ : 

                   âœ¨ ì ìš©ì˜µì…˜: ê¸°ë³¸í˜•

                   (ìœ„ ë ŒíŠ¸ë¹„ìš© ì„¹ì…˜)

                   ğŸ‘ ì´ëŸ° ë¶„ë“¤ê»˜ ì¶”ì²œ ! 
                   âœ”ï¸ (ë°ì´í„° ê¸°ë°˜ ì¶”ì²œ ì‚¬ìœ  3ê°€ì§€)

                   ğŸ“ ìƒë‹´ë¬¸ì˜
                   ì¹´í†¡ìƒë‹´ : ì¹´ì¹´ì˜¤í†¡ì— 'JETCAR' ë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”
                   í™ˆí˜ì´ì§€ ë°©ë¬¸ : https://www.jetcar.co.kr/

                5. ìƒì„¸ì„œì‹ì˜ˆì‹œì—ì„œ ê°ë‚´ìš© ì¤„ë°”ê¿ˆ ì˜í•´ì•¼í•©ë‹ˆë‹¤.
                """
                
                # ëª¨ë¸ëª…ì€ ì‹¤ì œ ì‚¬ìš© ê°€ëŠ¥í•œ gemini-1.5-flash ë“±ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
                model = genai.GenerativeModel('gemini-2.5-flash')
                response = model.generate_content(f"{system_prompt}\n\nì§ì› ì§ˆë¬¸: {user_input}")
                
                ai_response = response.text
                st.markdown(ai_response)
                st.session_state.messages.append({"role": "assistant", "content": ai_response})
            except Exception as e: 
                st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

# --- 5. UI ë©”ì¸ ---
st.title("ğŸš— JETCAR ìŠ¤ë§ˆíŠ¸ ìƒë‹´ ë¹„ì„œ")
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]): st.markdown(msg["content"])

if prompt := st.chat_input("ì°¨ëŸ‰ëª…ì´ë‚˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."):
    generate_ai_response(prompt)



