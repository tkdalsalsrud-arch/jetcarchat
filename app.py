import streamlit as st
import google.generativeai as genai
import os
import pandas as pd # 'pandas' (CSV/Excel ë¦¬ë”ê¸°)
from pathlib import Path

# --- 1. API í‚¤ ì„¤ì • (ì˜¤ì§ Gemini í‚¤ í•˜ë‚˜ë§Œ!) ---
try:
    # Secretsì—ì„œ API í‚¤ ë¶ˆëŸ¬ì˜¤ê¸°
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
except Exception as e:
    # ë¡œì»¬ secrets.toml íŒŒì¼ì´ ì—†ê±°ë‚˜ í‚¤ê°€ ì˜ëª»ë˜ì—ˆì„ ë•Œ
    st.error("ğŸš¨ [Gemini API í‚¤]ë¥¼ ì„¤ì •í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Secretsë¥¼ í™•ì¸í•˜ì„¸ìš”.")
    st.stop() # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì•± ì‹¤í–‰ ì¤‘ì§€

# --- 2. ì•± ì œëª© ë° ëª¨ë¸ ì„¤ì • ---
st.title("ğŸš— jetcar ì±—ë´‡ (v5: Excel RAG)")
st.caption("Powered by Streamlit & Google Gemini")

# ğŸš¨ (ìƒˆ ê¸°ëŠ¥ v5) 'Excel ì°¸ê³  ìë£Œ' ë¶ˆëŸ¬ì˜¤ê¸°
try:
    # app.pyì™€ ê°™ì€ ìœ„ì¹˜ì— ìˆëŠ” 'cars_data.xlsx' íŒŒì¼ì„ ì½ìŠµë‹ˆë‹¤.
    context_file = Path("cars_data.xlsx") # ğŸš¨ .csvì—ì„œ .xlsxë¡œ ë³€ê²½
    if not context_file.exists():
        st.error("ğŸš¨ 'cars_data.xlsx' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. app.pyì™€ ê°™ì€ ìœ„ì¹˜ì— ë§Œë“¤ì–´ì£¼ì„¸ìš”.")
        st.stop()
    
    # ğŸš¨ (ìˆ˜ì •ëœ ë¶€ë¶„!) pd.read_excelì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    # ì—‘ì…€ íŒŒì¼ì„ ì½ê¸° ìœ„í•´ 'engine="openpyxl"'ì´ í•„ìš”í•©ë‹ˆë‹¤.
    df = pd.read_excel(context_file, engine="openpyxl")
    
    # 'ì°¸ê³  ìë£Œ'ë¥¼ LLMì´ ì´í•´í•˜ê¸° ì‰¬ìš´ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
    context = "--- [jetcar ì°¸ê³  ìë£Œ] ---\n\n"
    
    # CSV ë²„ì „(v4)ê³¼ ë™ì¼: ëª¨ë“  ì—´ ì œëª©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    column_headers = df.columns.tolist() 

    for index, row in df.iterrows():
        # ì²« ë²ˆì§¸ ì—´ì˜ ê°’ì„ 'ì œëª©'ì²˜ëŸ¼ ì‚¬ìš© (ì˜ˆ: ì°¨ëŸ‰ëª…)
        context += f"[{row[column_headers[0]]}]\n" 
        
        # ë‚˜ë¨¸ì§€ ëª¨ë“  ì—´ì˜ ì •ë³´ë¥¼ 'í‚¤: ê°’' ìŒìœ¼ë¡œ ë™ì  ì¶”ê°€
        for col_name in column_headers[1:]: # ì²« ë²ˆì§¸ ì—´ ì œì™¸
            context += f"- {col_name}: {row[col_name]}\n"
        
        context += "\n" # ê° í•­ëª© ì‚¬ì´ì— ì¤„ë°”ê¿ˆ ì¶”ê°€
            
    context += "--- [ì°¸ê³  ìë£Œ ë] ---"

    st.info("âœ… 'cars_data.xlsx' (ì°¨ëŸ‰ ì •ë³´) ë¡œë”© ì™„ë£Œ!")

except Exception as e:
    st.error(f"ğŸš¨ 'cars_data.xlsx' íŒŒì¼ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
    st.stop()


# ì„¸ì…˜ ìƒíƒœ(session_state)ì— ëª¨ë¸ê³¼ ì±„íŒ… ê¸°ë¡ ì´ˆê¸°í™”
if "model" not in st.session_state:
    # 1.0 ì„¸ëŒ€ì˜ í‘œì¤€ ëª¨ë¸
    st.session_state.model = genai.GenerativeModel('gemini-2.5-flash')

if "chat" not in st.session_state:
    # ëª¨ë¸ì˜ ì±„íŒ… ì„¸ì…˜ ì‹œì‘ (ëŒ€í™” ê¸°ë¡ ìœ ì§€ë¥¼ ìœ„í•¨)
    st.session_state.chat = st.session_state.model.start_chat(history=[])

if "messages" not in st.session_state:
    # UIì— í‘œì‹œí•  ì±„íŒ… ê¸°ë¡
    st.session_state.messages = []

# --- 3. ì´ì „ ëŒ€í™” ë‚´ìš© í‘œì‹œ ---
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# --- 4. ì‚¬ìš©ì ì…ë ¥ ë° AI ì‘ë‹µ ì²˜ë¦¬ (v4ì™€ ë™ì¼) ---
if prompt := st.chat_input("ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”"):
    
    # 1. ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥ ë° UIì— í‘œì‹œ
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    # 2. AIì—ê²Œ ì‘ë‹µ ìš”ì²­ (ğŸš¨ 'ì°¸ê³  ìë£Œ'ì™€ í•¨ê»˜ ì§ˆë¬¸í•˜ë„ë¡ ìˆ˜ì •ë¨)
    with st.spinner("jetcarê°€ ìƒê° ì¤‘... ğŸš™ğŸ’¨"):
        try:
            # ğŸš¨ 'ì°¸ê³  ìë£Œ'ì™€ 'ì§ˆë¬¸'ì„ í•©ì³ì„œ 'ì˜¤í”ˆë¶ ì‹œí—˜' ë¬¸ì œë¡œ ë§Œë“­ë‹ˆë‹¤.
            final_prompt = f"""
            {context}
            
            [ì‚¬ìš©ì ì§ˆë¬¸]
            {prompt}
            
[ì§€ì‹œ]
            1. [ì‚¬ìš©ì ì§ˆë¬¸]ì— ëŒ€í•œ ë‹µë³€ì„ **ë¨¼ì €** [jetcar ì°¸ê³  ìë£Œ]ì—ì„œ ì°¾ì•„ë³´ì„¸ìš”.
            2. ë§Œì•½ [ì°¸ê³  ìë£Œ]ì— ì§ˆë¬¸ê³¼ **ê´€ë ¨ëœ ì •ë³´(ì˜ˆ: íŠ¹ì • ì°¨ëŸ‰ ì •ë³´)ê°€ ìˆë‹¤ë©´**, ê·¸ ìë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•˜ê²Œ ëŒ€ë‹µí•´ ì£¼ì„¸ìš”.
            3. ë§Œì•½ [ì°¸ê³  ìë£Œ]ì— **ë‹µì´ ì—†ê±°ë‚˜ ê´€ë ¨ì„±ì´ ë‚®ë‹¤ë©´** (ì˜ˆ: "ì¥ê¸°ë ŒíŠ¸ì¹´ì˜ ì¥ì ì€ ë¬´ì—‡ì¸ê°€ìš”?" ë˜ëŠ” "ì œíŠ¸ì¹´ íšŒì‚¬ëŠ” ì–´ë””ì— ìˆë‚˜ìš”?" ê°™ì€ ì¼ë°˜ ìƒì‹ ë° ìë£Œ ì™¸ ì§ˆë¬¸), "ì œê°€ ì•„ëŠ” ì •ë³´ ì¤‘ì—ëŠ” ì—†ìŠµë‹ˆë‹¤."ë¼ê³  ë§í•˜ì§€ **ë§ê³ **, **ë‹¹ì‹ ì˜ ì¼ë°˜ ì§€ì‹ì„ í™œìš©í•˜ì—¬ ì¹œì ˆí•˜ê²Œ ë‹µë³€í•´ ì£¼ì„¸ìš”.**
            4. ë§Œì•½ ì‚¬ìš©ì ì§ˆë¬¸ì´ ì°¨ëŸ‰ë²ˆí˜¸(ë˜ëŠ” ì°¨ëŸ‰ëª…)ë§Œ ì…ë ¥í•˜ëŠ” ê²½ìš°, [ì°¸ê³  ìë£Œ]ì—ì„œ ê·¸ ì°¨ëŸ‰ì„ ì°¾ì•„ ì•„ë˜ ì„œì‹ì— ë§ì¶° ìš”ì•½í•´ ì£¼ì„¸ìš”. ì´ ë•Œ 'ì´ëŸ° ë¶„ë“¤ê»˜ ì¶”ì²œ !' ë¶€ë¶„ì€ ë‹¹ì‹ ì´ ìë£Œë¥¼ ì°¸ê³ í•˜ì—¬ ì°½ì˜ì ìœ¼ë¡œ ì§ì ‘ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
                (ê¸°ì¡´ ì„œì‹ì€ ì—¬ê¸°ì— ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤...)
                ì œì¡°ì‚¬ ì—°ì‹ ì°¨ëŸ‰ëª… ì‹ ìš© ë¬´ê´€ ì „êµ­ ì¶œê³  

ì‹ ìš© ë¬´ê´€ / ë§Œ 26ì„¸ ì´ìƒ ~ 60ì„¸ì´í•˜ / ìš´ì „ê²½ë ¥ 1ë…„ì´ìƒ / ì „êµ­íƒì†¡ 

ğŸ“Œ ì°¨ëŸ‰ì •ë³´
ì°¨ëŸ‰ëª…: 
ì£¼í–‰ê±°ë¦¬ : 
ì—°ì‹: 
ì—°ë£Œ : 

âœ¨ ì ìš©ì˜µì…˜ 

ê¸°ë³¸í˜•

ğŸ’¸ ë ŒíŠ¸ë¹„ìš©
ë³´ì¦ê¸ˆ 80ë§Œì›
ì •ë¹„ í¬í•¨ ì—¬ë¶€ : ì •ë¹„ ë¯¸í¬í•¨
íƒì†¡ë£Œ : ë³„ë„ 

ğŸ“† 12ê°œì›” ë§Œì›

ğŸ“† 24ê°œì›” ë§Œì›

ğŸ“† 36ê°œì›” ë§Œì›

ğŸ“† 48ê°œì›” ë§Œì›

ğŸ“† 60ê°œì›” ë§Œì›


ğŸ‘ ì´ëŸ° ë¶„ë“¤ê»˜ ì¶”ì²œ ! 

âœ”ï¸ ì‹ ìš©ë“±ê¸‰ ìƒê´€ì—†ì´ ì°¨ëŸ‰ì´ í•„ìš”í•œ ë¶„

âœ”ï¸ ì§ ì‹£ëŠ” ê³µê°„ì´ ì¶©ë¶„í•œ ì°¨ëŸ‰ì„ ì°¾ê³  ê³„ì‹œëŠ” ë¶„

âœ”ï¸  ì‹ ìš© ê±±ì •ì—†ì´ ë¹ ë¥´ê²Œ íƒì†¡ ë°›ì•„ë³¼ ìˆ˜ ìˆëŠ” ì°¨ëŸ‰ì„ ì›í•˜ì‹œëŠ” ë¶„

ğŸ“ ìƒë‹´ë¬¸ì˜
ì¹´í†¡ìƒë‹´ : ì¹´ì¹´ì˜¤í†¡ì— 'JETCAR' ë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”
í™ˆí˜ì´ì§€ ë°©ë¬¸ : ë„¤ì´ë²„ ê²€ìƒ‰ì°½ì— 'ì œíŠ¸ì¹´'ë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”
            
            5. ëª¨ë“  ë‹µë³€ì€ ì§ˆë¬¸í•œ ì‚¬ëŒì´ ì‚¬ìš©í•œ ì–¸ì–´ë¡œ ëŒ€ë‹µí•´ ì£¼ì„¸ìš”.
            """

            # chat.send_messageë¥¼ ì‚¬ìš©í•´ì•¼ ëŒ€í™” ë§¥ë½ì´ ìœ ì§€ë©ë‹ˆë‹¤.
            response = st.session_state.chat.send_message(final_prompt)
            
            # 3. AI ì‘ë‹µ ì €ì¥ ë° UIì— í‘œì‹œ
            ai_response = response.text
            st.session_state.messages.append({"role": "assistant", "content": ai_response})
            with st.chat_message("assistant"):
                st.markdown(ai_response)
                
        except Exception as e:
            st.error(f"AI ì‘ë‹µ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
